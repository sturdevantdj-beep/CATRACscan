<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CATRAC Asset Location Capture</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.4; }
    .muted { color: #666; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h2>Logging Location…</h2>
  <p class="muted">If prompted, tap <b>Allow</b> to share your location.</p>
  <p id="status">Preparing…</p>

  <!--
    ▼▼ BEST PRACTICE ▼▼
    Replace this minimal form with Form A's full "Source Code" from Jotform,
    so the "action" and every input name= match exactly.
  -->
  <form id="silentForm" method="post" action="https://submit.jotform.com/submit/252387737300054/">
    <!-- REPLACE the action URL if your region/subdomain differs or if Jotform changes it -->
    <!-- IMPORTANT: name= attributes MUST match Form A's actual input names from its source code -->
    <input type="hidden" name="catracBarcode" />
    <input type="hidden" name="assetId" />
    <input type="hidden" name="assetName" />
    <input type="hidden" name="lat" />
    <input type="hidden" name="lon" />
    <input type="hidden" name="accuracy" />
  </form>

  <script>
    const params    = new URLSearchParams(location.search);
    const barcode   = params.get('catracBarcode') || params.get('b') || '';
    const assetId   = params.get('assetId') || '';
    const assetName = params.get('assetName') || '';

    const statusEl  = document.getElementById('status');
    const F         = document.getElementById('silentForm');
    const setVal    = (name, val) => {
      const el = F.querySelector(`[name="${name}"]`);
      if (el && val !== '' && val != null) el.value = val;
    };

    function submitNow(lat, lon, acc) {
      // identifiers
      setVal('catracBarcode', barcode);
      setVal('assetId', assetId);
      setVal('assetName', assetName);
      // coordinates
      if (lat != null && lon != null) {
        setVal('lat', String(lat));
        setVal('lon', String(lon));
      }
      if (acc != null) setVal('accuracy', String(Math.round(acc)));

      statusEl.textContent = 'Submitting…';
      F.submit(); // Jotform Form A Thank-You will redirect to the Salesforce Asset URL
    }

    function go() {
      if (!barcode) {
        statusEl.textContent = 'Missing barcode (?catracBarcode=).';
        return;
      }
      if (!('geolocation' in navigator)) {
        statusEl.textContent = 'No GPS available—submitting without coordinates…';
        submitNow(null, null, null);
        return;
      }
      statusEl.textContent = 'Requesting GPS…';
      navigator.geolocation.getCurrentPosition(
        p => {
          const { latitude, longitude, accuracy } = p.coords;
          statusEl.textContent = 'Location captured. Submitting…';
          submitNow(latitude, longitude, accuracy);
        },
        err => {
          statusEl.textContent = 'Could not get location (' + err.message + '). Submitting without GPS…';
          submitNow(null, null, null);
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    }

    go();
  </script>
</body>
</html>
