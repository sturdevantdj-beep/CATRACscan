<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CATRAC Asset Location Capture</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.4; }
    .btn { padding: 12px 16px; border: 1px solid #ccc; border-radius: 8px; background: #f6f6f6; }
    .muted { color: #666; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h2>Logging Location…</h2>
  <p class="muted">If prompted, tap <b>Allow</b> to share your location.</p>
  <p id="status">Preparing…</p>
  <button id="retry" class="btn" style="display:none;">Allow Location</button>

  <script>
    const params = new URLSearchParams(location.search);
    const barcode = params.get('catracBarcode') || params.get('b') || '';
    const assetId = params.get('assetId') || '';
    const formBase = 'https://form.jotform.com/YOUR_FORM_ID_HERE'; // <-- change this

    const statusEl = document.getElementById('status');
    const retryBtn = document.getElementById('retry');

    function next(lat, lon, acc) {
      const u = new URL(formBase);
      // Pass through the identifiers + coordinates
      if (barcode) u.searchParams.set('catracBarcode', barcode);
      if (assetId) u.searchParams.set('assetId', assetId);
      if (lat != null && lon != null) {
        u.searchParams.set('lat', lat.toString());
        u.searchParams.set('lon', lon.toString());
      }
      if (acc != null) u.searchParams.set('accuracy', Math.round(acc).toString());
      location.replace(u.toString());
    }

    function getGPS() {
      if (!barcode) {
        statusEl.textContent = 'Missing barcode. This QR must include ?catracBarcode=VALUE';
        return;
      }
      if (!('geolocation' in navigator)) {
        statusEl.textContent = 'Geolocation not supported—continuing without GPS…';
        next(null, null, null);
        return;
      }
      statusEl.textContent = 'Requesting GPS…';
      navigator.geolocation.getCurrentPosition(
        p => {
          const { latitude, longitude, accuracy } = p.coords;
          statusEl.textContent = 'Location captured. Opening form…';
          next(latitude, longitude, accuracy);
        },
        err => {
          // If user denied or timed out, still continue to form so they can submit notes/photos
          statusEl.textContent = 'Could not get location (' + err.message + '). Continuing…';
          next(null, null, null);
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    }

    // Some iOS versions prefer a user gesture. Try once automatically, show a button if needed.
    try {
      getGPS();
      // show retry button after a short delay in case prompt was blocked until a tap
      setTimeout(() => { retryBtn.style.display = 'inline-block'; }, 1200);
    } catch(e) {
      retryBtn.style.display = 'inline-block';
    }
    retryBtn.addEventListener('click', getGPS);
  </script>
</body>
</html>
