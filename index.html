<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CATRAC Asset Location Capture</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin:24px; line-height:1.4; }
    .muted { color:#666; font-size:0.9rem; }
    code { background:#f4f4f4; padding:2px 4px; border-radius:4px; }
    pre { background:#f9f9f9; padding:8px; border-radius:6px; overflow:auto; }
  </style>
</head>
<body>
  <h2>Logging Location‚Ä¶</h2>
  <p class="muted">If prompted, tap <b>Allow</b> to share your location.</p>
  <p id="status">Preparing‚Ä¶</p>

  <!-- ‚ñº‚ñº Replace this minimal form with your Jotform A "Source Code" for 100% name/action accuracy ‚ñº‚ñº -->
  <form id="silentForm" method="post" action="https://submit.jotform.com/submit/252387737300054/">
    <!-- IMPORTANT: change each name= to match the input names in your Jotform Source Code -->
    <input type="hidden" name="catracBarcode" />
    <input type="hidden" name="assetId" />
    <input type="hidden" name="assetName" />
    <input type="hidden" name="lat" />
    <input type="hidden" name="lon" />
    <input type="hidden" name="accuracy" />
  </form>
  <!-- ‚ñ≤‚ñ≤ End minimal form ‚ñ≤‚ñ≤ -->

  <script>
    const params    = new URLSearchParams(location.search);
    const barcode   = params.get('catracBarcode') || params.get('b') || '';
    const assetName = params.get('assetName') || '';
    const assetId   = params.get('assetId') || ''; // use CASESAFEID(Id) in your Salesforce QR to get 18-char
    const debug     = params.get('debug') === '1';

    const statusEl  = document.getElementById('status');
    const F         = document.getElementById('silentForm');

    function setVal(name, val) {
      const el = F.querySelector(`[name="${name}"]`);
      if (el && val !== '' && val != null) el.value = val;
      return !!el;
    }

    function payloadPreview() {
      const obj = {};
      F.querySelectorAll('input[name]').forEach(i => obj[i.name] = i.value);
      return obj;
    }

    function validateRequired() {
      // Make sure the inputs exist AND are filled before submit
      const requiredNames = ['catracBarcode', 'assetId']; // adjust if Asset__c isn‚Äôt required
      for (const n of requiredNames) {
        const el = F.querySelector(`[name="${n}"]`);
        if (!el) return { ok:false, msg:`Missing input element name="${n}" (check Jotform Source Code names)` };
        if (!el.value) return { ok:false, msg:`Required value "${n}" is empty` };
      }
      return { ok:true };
    }

    function submitNow(lat, lon, acc) {
      // identifiers
      setVal('catracBarcode', barcode);
      setVal('assetId', assetId);
      setVal('assetName', assetName);
      // coordinates (optional)
      if (lat != null && lon != null) {
        setVal('lat', String(lat));
        setVal('lon', String(lon));
      }
      if (acc != null) setVal('accuracy', String(Math.round(acc)));

      // tiny delay to ensure DOM reflects values before submit
      setTimeout(() => {
        const check = validateRequired();
        if (!check.ok) {
          statusEl.innerHTML = '‚ùå ' + check.msg + (debug ? '<br><br><b>Payload:</b><pre>'+JSON.stringify(payloadPreview(), null, 2)+'</pre>' : '');
          return;
        }

        if (debug) {
          statusEl.innerHTML = 'üîé DEBUG MODE ‚Äî not submitting. <br><br><b>Payload:</b><pre>'+JSON.stringify(payloadPreview(), null, 2)+'</pre>';
          return;
        }

        statusEl.textContent = 'Submitting‚Ä¶';
        F.submit(); // Jotform Thank-You should redirect to Salesforce Asset URL
      }, 50);
    }

    function go() {
      if (!barcode) { statusEl.textContent = 'Missing barcode (?catracBarcode=).'; return; }
      if (!assetId)  { statusEl.textContent = 'Missing assetId (?assetId=).'; return; }

      if (!('geolocation' in navigator)) {
        statusEl.textContent = 'No GPS available ‚Äî submitting without coordinates‚Ä¶';
        submitNow(null, null, null);
        return;
      }

      statusEl.textContent = 'Requesting GPS‚Ä¶';
      navigator.geolocation.getCurrentPosition(
        p => {
          const { latitude, longitude, accuracy } = p.coords;
          statusEl.textContent = 'Location captured. Submitting‚Ä¶';
          submitNow(latitude, longitude, accuracy);
        },
        err => {
          statusEl.textContent = 'Could not get location (' + err.message + '). Submitting without GPS‚Ä¶';
          submitNow(null, null, null);
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    }

    go();
  </script>
</body>
</html>
